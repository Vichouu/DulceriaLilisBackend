{% extends "base.html" %}
{% load static %}
{% block title %}Gesti√≥n Transacciones | Dulcer√≠a Lilis ERP{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4">

  <!-- T√≠tulo -->
  <div class="d-flex align-items-center gap-2 mt-2 mb-3">
    <h4 class="m-0 text-danger fw-bold">
      <i class="bi bi-clipboard-data me-2"></i>Gesti√≥n de Transacciones
    </h4>
    <div class="flex-grow-1">
      <hr class="border-top border-2 border-danger my-0" />
    </div>
  </div>

  <!-- üîç BUSCADOR Y FILTROS -->
  <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
    <form method="get" action="{% url 'transactional:list' %}" class="d-flex gap-2" data-live="search">
      <div class="input-group input-group-sm shadow-sm" style="min-width: 280px;">
        <input type="text" name="q" class="form-control border-danger" placeholder="Buscar por tipo / producto / SKU / cantidad / bodegas / proveedor / usuario / lote" value="{{ query|default:'' }}">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-search"></i>
        </button>
      </div>

      <select name="sort" class="form-select form-select-sm border-danger" onchange="this.form.dispatchEvent(new Event('submit',{cancelable:true}))">
        <option value="sku" {% if sort_by == 'sku' %}selected{% endif %} >Ordenar por...</option>
        <option value="fecha" {% if sort_by == 'fecha' %}selected{% endif %}>Fecha</option>
        <option value="-fecha" {% if sort_by == '-fecha' %}selected{% endif %}>Fecha (desc)</option>
        <option value="tipo" {% if sort_by == 'tipo' %}selected{% endif %}>Tipo</option>
        <option value="producto__nombre" {% if sort_by == 'producto__nombre' %}selected{% endif %}>Producto</option>
        <option value="-producto__nombre" {% if sort_by == '-producto__nombre' %}selected{% endif %}>Producto (desc)</option>
      </select>

      <select name="ver" class="form-select form-select-sm border-danger" onchange="this.form.dispatchEvent(new Event('submit',{cancelable:true}))">
        <option value="todos" {% if ver == 'todos' %}selected{% endif %}>Todos</option>
        <option value="ingreso" {% if ver == 'ingreso' %}selected{% endif %}>Ingreso</option>
        <option value="salida" {% if ver == 'salida' %}selected{% endif %}>Salida</option>
        <option value="ajuste" {% if ver == 'ajuste' %}selected{% endif %}>Ajuste</option>
        <option value="devolucion" {% if ver == 'devolucion' %}selected{% endif %}>Devoluci√≥n</option>
        <option value="transferencia" {% if ver == 'transferencia' %}selected{% endif %}>Transferencia</option>
      </select>

      <a class="btn btn-success btn-sm d-flex align-items-center shadow-sm"
         href="{% url 'transactional:list' %}?q={{ query }}&sort={{ sort_by }}&export=xlsx">
        <i class="bi bi-file-earmark-excel me-2"></i>Exportar
      </a>
    </form>
  </div>

  <div class="row g-3 align-items-start">

    <!-- üìã FORMULARIO -->
    <div class="col-12 col-lg-4 col-xxl-3">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-danger fw-bold mb-3 d-flex align-items-center">
            <i class="bi bi-plus-circle-fill me-2"></i>Registrar movimiento
          </h6>

          <form id="form-mov" class="needs-validation" novalidate>
            <!-- TABS -->
            <ul class="nav nav-tabs mb-3" id="movTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active text-danger fw-semibold" id="tab-datos" data-bs-toggle="tab"
                        data-bs-target="#pane-datos" type="button" role="tab">Datos Generales</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-avanzado" data-bs-toggle="tab"
                        data-bs-target="#pane-avanzado" type="button" role="tab">Control</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-referencias" data-bs-toggle="tab"
                        data-bs-target="#pane-referencias" type="button" role="tab">Referencias</button>
              </li>
            </ul>

            <div class="tab-content" id="movTabsContent">
              <!-- DATOS -->
              <div class="tab-pane fade show active" id="pane-datos" role="tabpanel">
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small">Fecha</label>
                    <input id="movFecha" name="fecha" type="date" class="form-control form-control-sm" disabled readonly>
                    <div class="form-text small">Se registrar√° la fecha actual.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Tipo <span class="text-danger">*</span></label>
                    <select id="movTipo" name="tipo" class="form-select form-select-sm" required>
                      <option value="">Seleccione...</option>
                      <option>Ingreso</option>
                      <option>Salida</option>
                      <option>Ajuste</option>
                      <option>Devoluci√≥n</option>
                      <option>Transferencia</option>
                    </select>
                    <div class="invalid-feedback">Selecciona un tipo.</div>
                  </div>

                  <div class="col-6">
                    <label class="form-label small">Producto <span class="text-danger">*</span></label>
                    <input id="movProducto" name="producto_text" type="text" class="form-control form-control-sm" required placeholder="SKU o nombre">
                    <input type="hidden" id="movProductoId" name="producto_id" value="">
                    <div class="invalid-feedback">Producto obligatorio.</div>
                  </div>

                  <div class="col-6">
                    <label class="form-label small">Proveedor</label>
                    <input id="movProveedor" name="proveedor_text" type="text" class="form-control form-control-sm" placeholder="Opcional">
                    <input type="hidden" id="movProveedorId" name="proveedor_id" value="">
                    <div class="form-text small">Requerido en Ingreso/Devoluci√≥n.</div>
                    <div class="invalid-feedback">Proveedor requerido para este tipo.</div>
                  </div>

                  <div class="col-6">
                    <label for="form-label small">Bodega de Origen</label>
                    <select id="movBodegaOrigen" name="bodega_origen" class="form-select form-select-sm mb-2" required>
                      <option value="">Seleccione...</option>
                      {% for b in bodegas %}
                      <option value="{{ b.id }}">{{ b.nombre }}</option>
                      {% endfor %}
                    </select>
                    <div class="form-text small">Requerido en Transferencia.</div>
                    <div class="invalid-feedback">Proveedor requerido para este tipo.</div>
                  </div>

                  <div class="col-6">
                    <label for="form-label small">Bodega de Destino</label>
                    <select id="movBodegaDestino" name="bodega_destino" class="form-select form-select-sm mb-2" required>
                      <option value="">Seleccione...</option>
                      {% for b in bodegas %}
                      <option value="{{ b.id }}">{{ b.nombre }}</option>
                      {% endfor %}
                    </select>
                    <div class="form-text small">Requerido en Transferencia.</div>
                    <div class="invalid-feedback">Proveedor requerido para este tipo.</div>
                  </div>

                  <div class="col-6">
                    <label class="form-label small">Cantidad <span class="text-danger">*</span></label>
                    <input id="movCantidad" name="cantidad" type="number" class="form-control form-control-sm" step="1" min="0" required>
                    <div class="invalid-feedback">Cantidad igual o mayor a 0.</div>
                  </div>
                </div>
              </div>

              <!-- CONTROL -->
              <div class="tab-pane fade" id="pane-avanzado" role="tabpanel">
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small">Lote</label>
                    <input id="movLote" name="lote" type="text" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">Error en el lote.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Serie</label>
                    <input id="movSerie" name="serie" type="text" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">Error en la serie.</div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Fecha vencimiento</label>
                    <input id="movVenc" name="vencimiento" type="date" class="form-control form-control-sm" required>
                    <div class="form-text small">Si se informa, no puede estar vencida para Ingreso/Transferencia.</div>
                  </div>
                </div>
              </div>

              <!-- REFERENCIAS -->
              <div class="tab-pane fade" id="pane-referencias" role="tabpanel">
                <div class="row g-2">
                  <div class="col-12">
                    <label class="form-label small">Doc. Referencia <span class="text-danger">*</span></label>
                    <input id="movDoc" name="doc_ref" type="text" class="form-control form-control-sm" placeholder="DL-101" required>
                    <div class="invalid-feedback">Error en el documento.</div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Motivo <span class="text-danger">*</span></label>
                    <input id="movMotivo" name="motivo" type="text" class="form-control form-control-sm" required placeholder="Opcional">
                    <div class="form-text small">Requerido en Ajuste/Devoluci√≥n.</div>
                    <div class="invalid-feedback">El motivo es obligatorio para este tipo de movimiento.</div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Observaciones</label>
                    <textarea id="movObs" name="observaciones" class="form-control form-control-sm" rows="2" placeholder="Notas..."></textarea>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="submit" class="btn btn-sm btn-danger flex-grow-1">
                <i class="bi bi-check-lg me-1"></i>Guardar
              </button>
              <button type="button" id="btn-clear-mov" class="btn btn-sm btn-outline-danger px-3">
                <i class="bi bi-eraser me-1"></i>Limpiar
              </button>
            </div>
            <div id="movMsg" class="small mt-2"></div>
          </form>
        </div>
      </div>
    </div>

    <!-- üìÑ TABLA -->
    <div class="col-12 col-lg-8 col-xxl-9">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="text-danger fw-bold mb-3 d-flex align-items-center">
              <i class="bi bi-clipboard-data me-2"></i>Movimientos Registrados
            </h6>
          </div>

          <div class="table-responsive" style="max-height:520px; overflow-y:auto;">
            <table class="table table-hover table-striped align-middle mb-0" id="movTable">
              <thead class="table-light text-nowrap">
                <tr>
                  <th>Fecha</th><th>Tipo</th><th>Producto</th><th>SKU</th><th class="text-center">Cantidad</th>
                  <th>Bodega Origen</th><th>Bodega Destino</th><th>Proveedor</th><th>Usuario</th><th>Lote</th>
                  <th>Vencimiento</th><th>Acciones</th>
                </tr>
              </thead>
              <tbody id="list-body">
                {% for m in movimientos %}
                <tr id="mov-{{ m.id }}">
                  <td>{{ m.fecha|date:"d/m/Y H:i" }}</td>
                  <td>{{ m.get_tipo_display }}</td>
                  <td>{{ m.producto.nombre }}</td>
                  <td>{{ m.producto.sku }}</td>
                  <td class="text-center">{{ m.cantidad|floatformat:2 }}</td>
                  <td>{{ m.bodega_origen.nombre|default:"-" }}</td>
                  <td>{{ m.bodega_destino.nombre|default:"-" }}</td>
                  <td>{{ m.proveedor.razon_social|default:"-" }}</td>
                  <td>{{ m.creado_por.username|default:"Sistema" }}</td>
                  <td>{{ m.lote|default:"-" }}</td>
                  <td>{{ m.fecha_vencimiento|date:"d/m/Y"|default:"-" }}</td>
                  <td>
                    <button class="btn btn-sm btn-warning" onclick="editarMovimiento('{{ m.id }}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="eliminarMovimiento('{{ m.id }}')"><i class="bi bi-trash"></i></button>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="13" class="text-center text-muted">Sin resultados</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Paginador -->
          <div class="d-flex justify-content-between align-items-center border-top border-danger pt-3 mt-3">
            <small id="list-pagination-label" class="text-danger">Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }} de {{ page_obj.paginator.count }} movimientos</small>
            <nav id="list-pagination" aria-label="Paginaci√≥n de movimientos">
              <ul class="pagination pagination-sm mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link border-danger text-danger" href="?page=1&q={{ query }}&sort={{ sort_by }}&ver={{ ver }}">&laquo;</a>
                </li>
                <li class="page-item">
                  <a class="page-link border-danger text-danger" href="?page={{ page_obj.previous_page_number }}&q={{ query }}&sort={{ sort_by }}&ver={{ ver }}">Anterior</a>
                </li>
                {% endif %}
                <li class="page-item active">
                  <span class="page-link bg-danger border-danger">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                </li>
                {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link border-danger text-danger" href="?page={{ page_obj.next_page_number }}&q={{ query }}&sort={{ sort_by }}&ver={{ ver }}">Siguiente</a>
                </li>
                <li class="page-item">
                  <a class="page-link border-danger text-danger" href="?page={{ page_obj.paginator.num_pages }}&q={{ query }}&sort={{ sort_by }}&ver={{ ver }}">&raquo;</a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ========== JS ========== -->
<script src="{% static 'js/main.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  .swal-container { text-align: left !important; }
  .swal-label-input { margin-bottom: 1rem; }
  .swal-label-input label { display: block; margin-bottom: .25rem; font-size: .9rem; color: #555; }
  .swal-label-input .swal2-input, .swal-label-input .swal2-select { width: 100% !important; margin: 0 !important; }
  .swal2-select { display: block !important; }
</style>

<script>
(function(){
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const CSRF = getCookie("csrftoken");

  // Helpers
  function markValidity(el, ok) {
    if(!el) return;
    el.classList.toggle('is-invalid', !ok);
    el.classList.toggle('is-valid', ok);
  }
  function showMsg(el, text, ok=true){
    el.classList.remove('text-danger','text-success');
    el.classList.add(ok?'text-success':'text-danger');
    el.textContent = text;
  }

  function switchToTabOf(element){
    const pane = element.closest('.tab-pane');
    if (pane && !pane.classList.contains('active')) {
      const trigger = document.querySelector(`[data-bs-target="#${pane.id}"]`);
      if (trigger) new bootstrap.Tab(trigger).show();
    }
  }

  // FECHA HOY
  const today = new Date().toISOString().split('T')[0];
  const movFechaEl = document.getElementById('movFecha');
  if (movFechaEl) movFechaEl.value = today;

  // VALIDACI√ìN EN TIEMPO REAL
  (function attachFieldValidation() {
    const fields = {
      'movTipo':      el => !!el.value,
      'movProducto':  el => !!el.value.trim(),
      'movCantidad':  el => el.value !== '' && !isNaN(el.value) && parseFloat(el.value) > 0,
    };

    for (const id in fields) {
      const el = document.getElementById(id);
      if (el) {
        const event = (el.tagName === 'SELECT') ? 'change' : 'input';
        el.addEventListener(event, () => markValidity(el, fields[id](el)));
      }
    }
  })();

  // LOGICA DINAMICA SEGUN TIPO (Transferencia vs Otros)
  const movTipoSelect = document.getElementById('movTipo');
  const movCantidadInput = document.getElementById('movCantidad');
  const movBodegaOrigenSelect = document.getElementById('movBodegaOrigen');
  const movBodegaDestinoSelect = document.getElementById('movBodegaDestino');

  function updateFormState() {
    const tipo = movTipoSelect.value;
    const isTransfer = (tipo === 'Transferencia');

    // 1. Resetear estado: desbloquear cantidad, bloquear y limpiar bodegas
    movCantidadInput.disabled = false;
    movCantidadInput.setAttribute('required', 'true');

    movBodegaOrigenSelect.disabled = true;
    movBodegaOrigenSelect.removeAttribute('required');
    movBodegaOrigenSelect.value = "";

    movBodegaDestinoSelect.disabled = true;
    movBodegaDestinoSelect.removeAttribute('required');
    movBodegaDestinoSelect.value = "";

    if (isTransfer) {
      // Transferencia: Cantidad bloqueada (auto), Ambas bodegas requeridas
      movCantidadInput.disabled = true;
      movCantidadInput.removeAttribute('required');
      movCantidadInput.value = ''; // Se limpiar√° visualmente, backend asigna valor

      movBodegaOrigenSelect.disabled = false;
      movBodegaOrigenSelect.setAttribute('required', 'true');
      
      movBodegaDestinoSelect.disabled = false;
      movBodegaDestinoSelect.setAttribute('required', 'true');
    } else if (['Ingreso', 'Ajuste', 'Devoluci√≥n'].includes(tipo)) {
      // Entradas: Requieren Bodega Destino
      movBodegaDestinoSelect.disabled = false;
      movBodegaDestinoSelect.setAttribute('required', 'true');
    } else if (tipo === 'Salida') {
      // Salidas: Requieren Bodega Origen
      movBodegaOrigenSelect.disabled = false;
      movBodegaOrigenSelect.setAttribute('required', 'true');
    }
  }

  if(movTipoSelect) {
    movTipoSelect.addEventListener('change', updateFormState);
    // Ejecutar al inicio por si hay valor preseleccionado
    updateFormState();
  }

  // VALIDACI√ìN GENERAL
  function validateForm(formEl){
    let ok = true;
    let firstInvalid = null;

    // 1. Validar TODOS los campos con `required` en el formulario
    formEl.querySelectorAll("input[required], select[required], textarea[required]").forEach(el => {
      const isValid = !!(el.value || '').trim();
      markValidity(el, isValid);
      if (!isValid) {
        ok = false;
        if (!firstInvalid) firstInvalid = el;
      }
    });

    // 2. Validaciones condicionales (que no usan `required`)
    const tipoMov = document.getElementById('movTipo').value;
    const proveedorInput = document.getElementById('movProveedor');
    const motivoInput = document.getElementById('movMotivo');

    const esProveedorRequerido = ['Ingreso', 'Devoluci√≥n'].includes(tipoMov);
    const proveedorValido = !esProveedorRequerido || !!proveedorInput.value.trim();
    markValidity(proveedorInput, proveedorValido);
    if (!proveedorValido) { ok = false; if (!firstInvalid) firstInvalid = proveedorInput; }

    const esMotivoRequerido = ['Ajuste', 'Devoluci√≥n'].includes(tipoMov);
    const motivoValido = !esMotivoRequerido || !!motivoInput.value.trim();
    markValidity(motivoInput, motivoValido);
    if (!motivoValido) { ok = false; if (!firstInvalid) firstInvalid = motivoInput; }

    if (firstInvalid) {
      switchToTabOf(firstInvalid);
      firstInvalid.focus();
    }
    return ok;
  }

  // CREAR MOVIMIENTO
  document.getElementById('form-mov')?.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const form = ev.target;
    const movMsg = document.getElementById('movMsg');
    movMsg.textContent = '';
    if(!validateForm(form)){ showMsg(movMsg,'Revisa los campos resaltados.',false); return; }

    const payload = {
      tipo: document.getElementById('movTipo').value.trim(),
      fecha: document.getElementById('movFecha').value.trim(),
      cantidad: document.getElementById('movCantidad').value.trim() || "0", // Enviar 0 si est√° deshabilitado/vac√≠o

      producto_id: document.getElementById('movProductoId').value || null,
      proveedor_id: document.getElementById('movProveedorId').value || null,

      bodega_origen: document.getElementById('movBodegaOrigen').value || null,
      bodega_destino: document.getElementById('movBodegaDestino').value || null,

      producto_text: document.getElementById('movProducto').value.trim(),
      proveedor_text: document.getElementById('movProveedor').value.trim(),

      lote: document.getElementById('movLote').value.trim(),
      serie: document.getElementById('movSerie').value.trim(),
      vencimiento: document.getElementById('movVenc').value.trim(),

      doc_ref: document.getElementById('movDoc').value.trim(),
      motivo: document.getElementById('movMotivo').value.trim(),
      observaciones: document.getElementById('movObs').value.trim()
    };

    try{
      const resp = await fetch("{% url 'transactional:crear' %}", {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'X-CSRFToken':CSRF,
          'X-Requested-With':'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
      });

      const data = await resp.json();
      if(!resp.ok || !data.ok){
        const errs = data.errors || {};
        for(const k in errs){
          // Mapeo de nombres de backend a IDs de frontend
          const fieldId = { producto_text: 'movProducto', proveedor_text: 'movProveedor' }[k] || `mov${k.charAt(0).toUpperCase() + k.slice(1)}`;
          const field = document.getElementById(fieldId);
          if(field) markValidity(field, false); // Solo marca como inv√°lido, el mensaje ya est√° en el HTML
        }
        showMsg(movMsg, errs.__all__ || 'Revisa los campos con errores.', false);
        return;
      }
      showMsg(movMsg, 'Movimiento creado correctamente.', true);
      setTimeout(()=> location.reload(), 900);
    }catch(e){
      console.error(e);
      showMsg(movMsg,'Error al crear movimiento.',false);
    }
  });

  // LIMPIAR
  document.getElementById('btn-clear-mov')?.addEventListener('click', ()=>{
    document.getElementById('form-mov').reset();
    document.querySelectorAll('#form-mov .is-invalid').forEach(i=> i.classList.remove('is-invalid'));
    document.getElementById('movMsg').textContent='';
  });

  // EDITAR MOVIMIENTO
  async function editarMovimiento(id){
    try{
      const r = await fetch(`/transacciones/editar/${id}/`);
      if(!r.ok) throw new Error('No se pudo obtener el movimiento.');
      const data = await r.json();

      const { value: vals } = await Swal.fire({
        title:'Editar Movimiento',
        html: `
          <div class="swal-label-input"><label for="swal-fecha">Fecha</label><input id="swal-fecha" type="date" class="swal2-input" value="${data.movimiento.fecha.split('T')[0]}"></div>
          <div class="swal-label-input"><label for="swal-tipo">Tipo</label><input id="swal-tipo" class="swal2-input" value="${data.movimiento.tipo}"></div>
          <div class="swal-label-input"><label for="swal-cantidad">Cantidad</label><input id="swal-cantidad" type="number" step="1" class="swal2-input" value="${data.movimiento.cantidad}"></div>
        `,
        customClass:{ htmlContainer:'swal-container' },
        showCancelButton:true,
        confirmButtonColor:'#d33',
        confirmButtonText:'Guardar',
        cancelButtonText:'Cancelar',
        preConfirm:()=>({
          fecha: document.getElementById('swal-fecha').value,
          tipo: document.getElementById('swal-tipo').value,
          cantidad: document.getElementById('swal-cantidad').value
        })
      });

      if(vals){
        const pr = await fetch(`/transacciones/editar/${id}/`, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
          body: JSON.stringify(vals)
        });
        const out = await pr.json();

        if(out.ok){
          Swal.fire('¬°Actualizado!','El movimiento ha sido actualizado.','success')
           .then(()=>location.reload());
        } else {
          Swal.fire('Error', out.error || 'No se pudo actualizar.', 'error');
        }
      }

    }catch(e){
      Swal.fire('Error', e.message || 'Ocurri√≥ un error inesperado.', 'error');
    }
  }

  // üß® FUNCI√ìN FINAL ELIMINAR ‚Äî SIN INPUT RARO
  async function eliminarMovimiento(id){
    const confirm = await Swal.fire({
      title: '¬øEliminar movimiento?',
      text: 'Esta acci√≥n no se puede revertir.',
      icon: 'warning',

      input: '',          // ‚ùå mata cualquier input heredado
      inputOptions: {},

      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'S√≠, eliminar',
      cancelButtonText: 'Cancelar',

      willOpen: () => {
        const popup = Swal.getPopup();
        if (!popup) return;

        popup.querySelectorAll('.swal2-select, .swal2-input, .swal2-textarea')
            .forEach(el => el.remove());

        const html = Swal.getHtmlContainer();
        if (html) html.style.marginBottom = '0';
      },

      didOpen: () => {
        const popup = Swal.getPopup();
        if (!popup) return;

        popup.querySelectorAll('.swal2-select, .swal2-input, .swal2-textarea')
            .forEach(el => el.style.display = 'none');

        const html = Swal.getHtmlContainer();
        if (html) html.style.marginBottom = '0';
      }
    });

    if (!confirm.isConfirmed) return;

    const r = await fetch(`/transacciones/eliminar/${id}/`, {
      method:'POST',
      headers:{'X-CSRFToken':CSRF}
    });

    const j = await r.json();

    if(j.ok){
      Swal.fire('¬°Eliminado!','El movimiento ha sido eliminado.','success')
        .then(()=> location.reload());
    } else {
      Swal.fire('Error', j.error || 'No se pudo eliminar.', 'error');
    }
  }

  window.editarMovimiento = editarMovimiento;
  window.eliminarMovimiento = eliminarMovimiento;

  // LIVE SEARCH
  function setupLiveSearch(root=document){
    const log = (...a)=>{/* console.log('[live-search]',...a); */};

    function extractAndSwap(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html,'text/html');
      const newBody  = doc.getElementById('list-body');
      const newPagi  = doc.getElementById('list-pagination');
      const newLabel = doc.getElementById('list-pagination-label');

      if(newBody)  document.getElementById('list-body')?.replaceWith(newBody);
      if(newPagi)  document.getElementById('list-pagination')?.replaceWith(newPagi);
      if(newLabel) document.getElementById('list-pagination-label')?.replaceWith(newLabel);
    }

    async function doFetch(url){
      const r = await fetch(url,{ headers:{'X-Requested-With':'XMLHttpRequest'}});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.text();
    }

    const searchForm  = root.querySelector('form[data-live="search"]');
    if(!searchForm) return;

    const searchInput = searchForm.querySelector('input[name="q"]');
    if(!searchInput) return;

    let t;
    searchInput.addEventListener('input', function(){
      clearTimeout(t);
      t = setTimeout(()=> searchForm.dispatchEvent(new Event('submit',{cancelable:true})), 400);
    });

    searchForm.addEventListener('submit', function(ev){
      ev.preventDefault();
      const url = new URL(this.action || window.location.href);
      const fd  = new FormData(this);
      fd.forEach((v,k)=> url.searchParams.set(k,v));

      url.searchParams.delete('page');
      const qVal = (fd.get('q')||'').trim();
      if(qVal === '') url.search = '';

      document.body.style.cursor='progress';

      doFetch(url.toString())
        .then(html=>{
          extractAndSwap(html);
          window.history.replaceState({},'',url.toString());
        })
        .finally(()=>{ document.body.style.cursor=''; });
    });

    root.addEventListener('click', function(ev){
      const a = ev.target.closest('#list-pagination a.page-link, #list-pagination a');
      if(!a) return;
      ev.preventDefault();
      const href = a.getAttribute('href'); if(!href) return;

      document.body.style.cursor='progress';
      doFetch(href)
        .then(html=>{
          extractAndSwap(html);
          window.history.replaceState({},'',href);
        })
        .finally(()=>{ document.body.style.cursor=''; });
    });
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>setupLiveSearch());
  } else {
    setupLiveSearch();
  }

})();
</script>

{% endblock %}
