{% extends "base.html" %}
{% load static %}

{% block title %}Cambiar contraseña · Dulcería Lilis{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <div class="text-center mb-3">
                    <img src="{% static 'img/lilis.png' %}" alt="Lilis" style="height:56px">
                    <h4 class="mt-2">Cambiar contraseña</h4>
                </div>

                {% if messages %}
                {% for m in messages %}
                <div class="alert alert-{{ m.tags }} py-2 mb-2">{{ m }}</div>
                {% endfor %}
                {% endif %}

                <form id="changePasswordForm" method="post" novalidate autocomplete="off">
                    {% csrf_token %}

                    <input type="text" name="prevent_autofill" autocomplete="off" style="opacity:0; height:0; border:0; padding:0; position:absolute; left:-9999px;">
                    <input type="password" name="prevent_autofill2" autocomplete="new-password" style="opacity:0; height:0; border:0; padding:0; position:absolute; left:-9999px;">

                    <div class="mb-3">
                        <label class="form-label" for="id_old_password">Contraseña actual</label>
                        <input type="password" id="id_old_password" name="fake_old_password" class="form-control" autocomplete="new-password" required>
                        {% for e in form.old_password.errors %}
                        <div class="text-danger small">{{ e }}</div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="id_new_password1">Nueva contraseña</label>

                        <div class="input-group">
                            <input type="password" id="id_new_password1" name="new_password1" class="form-control" autocomplete="new-password" required>
                            <button class="btn btn-outline-secondary" type="button" id="togglePwd1">
                                <i class="bi bi-eye-slash" id="iconPwd1"></i>
                            </button>
                        </div>

                        <div class="invalid-feedback">La contraseña es demasiado débil.</div>

                        <div class="progress mt-2" style="height: 6px;">
                            <div id="pwdStrengthBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                        </div>

                        {% if form.new_password1.help_text %}
                        <div class="form-text">{{ form.new_password1.help_text }}</div>
                        {% endif %}
                        {% for e in form.new_password1.errors %}
                        <div class="text-danger small">{{ e }}</div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="id_new_password2">Confirmar nueva contraseña</label>

                        <div class="input-group">
                            <input type="password" id="id_new_password2" name="new_password2" class="form-control" autocomplete="new-password" required onpaste="return false" oncopy="return false" oncut="return false">
                            <button class="btn btn-outline-secondary" type="button" id="togglePwd2">
                                <i class="bi bi-eye-slash" id="iconPwd2"></i>
                            </button>
                        </div>

                        <div class="invalid-feedback">Las contraseñas no coinciden.</div>
                        {% for e in form.new_password2.errors %}
                        <div class="text-danger small">{{ e }}</div>
                        {% endfor %}
                    </div>

                    {% if form.fields.invite_code %}
                    <div class="mb-3">
                        <label class="form-label" for="id_invite_code">Código de verificación</label>
                        <input type="text" id="id_invite_code" name="invite_code" maxlength="12" class="form-control" autocomplete="off" {% if form.fields.invite_code.required %}required{% endif %}>
                        {% for e in form.invite_code.errors %}
                        <div class="text-danger small">{{ e }}</div>
                        {% endfor %}
                        {% if form.invite_code.help_text %}
                        <div class="form-text">{{ form.invite_code.help_text }}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <button class="btn btn-danger w-100">
                        Cambiar contraseña
                    </button>

                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    document.getElementById("id_old_password").setAttribute("name", "old_password");

    const form = document.querySelector("form");
    const pwd1 = document.getElementById("id_new_password1");
    const pwd2 = document.getElementById("id_new_password2");
    const bar = document.getElementById("pwdStrengthBar");

    document.getElementById("togglePwd1").addEventListener("click", () => togglePassword(pwd1, "iconPwd1"));
    document.getElementById("togglePwd2").addEventListener("click", () => togglePassword(pwd2, "iconPwd2"));

    function togglePassword(input, iconId) {
        const icon = document.getElementById(iconId);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.replace("bi-eye-slash", "bi-eye");
        } else {
            input.type = "password";
            icon.classList.replace("bi-eye", "bi-eye-slash");
        }
    }

    pwd1.addEventListener("input", () => { validarFuerza(); validarCoincidencia(); });
    pwd2.addEventListener("input", validarCoincidencia);

    function validarFuerza() {
        const score = calcularFuerza(pwd1.value.trim());
        bar.style.width = score.percent + "%";
        bar.className = "progress-bar " + score.color;

        pwd1.classList.toggle("is-valid", score.valid);
        pwd1.classList.toggle("is-invalid", !score.valid);
    }

    function validarCoincidencia() {
        if (!pwd2.value) return pwd2.classList.remove("is-valid", "is-invalid");

        const ok = pwd1.value === pwd2.value;
        pwd2.classList.toggle("is-valid", ok);
        pwd2.classList.toggle("is-invalid", !ok);
    }

    function calcularFuerza(pwd) {
        let puntos = 0;
        if (pwd.length >= 12) puntos++;
        if (/[a-z]/.test(pwd)) puntos++;
        if (/[A-Z]/.test(pwd)) puntos++;
        if (/[0-9]/.test(pwd)) puntos++;
        if (/[^A-Za-z0-9]/.test(pwd)) puntos++;

        const triviales = ["admin", "password", "1234", "abcd", "qwerty", "user", "lilis"];
        if (triviales.some(t => pwd.toLowerCase().includes(t))) puntos = 1;

        const estados = [
            { percent: 20, color: "bg-danger", valid: false },
            { percent: 40, color: "bg-warning", valid: false },
            { percent: 60, color: "bg-info", valid: false },
            { percent: 80, color: "bg-primary", valid: true },
            { percent: 100, color: "bg-success", valid: true }
        ];
        return estados[Math.min(puntos, 4)];
    }

    // ======================================================
    // AJAX SUBMIT — SweetAlert2 — muestra errores sin borrar
    // ======================================================

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const segura = calcularFuerza(pwd1.value).valid;
        const coincide = pwd1.value === pwd2.value;

        if (!segura) return pwd1.classList.add("is-invalid");
        if (!coincide) return pwd2.classList.add("is-invalid");

        const formData = new FormData(form);

        fetch("", {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            body: formData,
        })
        .then(async r => {
            let data;
            try {
                data = await r.json();
            } catch (err) {
                console.error("El servidor devolvió HTML, no JSON");
                return;
            }

            if (!data.ok) {
                mostrarErrores(data.errors);
                return;
            }

            Swal.fire({
                icon: "success",
                title: "Contraseña actualizada",
                text: "Tu contraseña fue cambiada correctamente.",
                confirmButtonColor: "#d33"
            }).then(() => {
                window.location.href = data.redirect;
            });
        })
        .catch(err => console.error(err));
    });


    function mostrarErrores(errors) {
        // Limpia errores previos
        document.querySelectorAll(".text-danger.small.dynamic-error").forEach(el => el.remove());

        for (let field in errors) {
            const input = document.querySelector(`[name="${field}"]`);
            if (!input) continue;

            input.classList.add("is-invalid");

            let errorDiv = document.createElement("div");
            errorDiv.className = "text-danger small dynamic-error";
            errorDiv.innerHTML = errors[field].join("<br>");

            input.parentElement.appendChild(errorDiv);
        }
    }
});
</script>

{% endblock %}